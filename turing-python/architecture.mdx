---
title: '体系结构'
description: '引擎、下载器、中间件、管道与消息流转的技术细节'
icon: 'diagram-project'
---

## 引擎（Engine）

`crawler/engine.py` 负责：
- 订阅多个 Topic/队列，异步消费与并发控制
- 加载下载器（`config.spider.downloader_modules`）、中间件（`config.spider.middlewares`）、管道（`config.spider.pipelines`）
- 前置/后置中间件处理（`_do_process_link` / `_do_process_response`）
- 回调分发与批量发布新链接（`_batch_process_links` / `_publish_links`）
- 任务跟踪、续期、过期检测与统计
- Prometheus 指标与错误类型统计

<CodeGroup>

```python 引擎核心片段（回调产物分发）
async def _handle_response(self, response: Response, link: Link, message, context):
    callback = spider_manager.get_link_callback(link)
    if not callback:
        return
    link_queue = asyncio.Queue(maxsize=1000)
    discovery_queue = asyncio.Queue(maxsize=1000)
    async def _iter_callback():
        async for obj in to_iterable(callback, response=response, link=link, context=context):
            if isinstance(obj, Link):
                await link_queue.put(obj)
            elif isinstance(obj, Response):
                await self._handle_item(CommonSpiderItem(...), link)
            elif isinstance(obj, (str, DiscoveryLink)):
                await discovery_queue.put(obj)
            elif ItemAdapter.is_item(obj):
                await self._handle_item(obj, link)
        await link_queue.put(StopIteration)
        await discovery_queue.put(StopIteration)
    await asyncio.gather(
        asyncio.create_task(self._batch_process_links(link_queue, link)),
        asyncio.create_task(self._batch_process_discoveries(discovery_queue, link, response)),
        asyncio.create_task(_iter_callback()),
    )
```

```python 链接属性继承（保持上下文一致）
def _inherit_link_attributes(child_link: Link, parent_link: Link):
    child_link.demand_id = parent_link.demand_id
    child_link.task_id = parent_link.task_id
    child_link.sub_dir = parent_link.sub_dir
    child_link.proxy_agent = child_link.proxy_agent or parent_link.proxy_agent
    if parent_link.is_attach_attr:
        if parent_link.middlewares is not None and child_link.middlewares is None:
            child_link.middlewares = parent_link.middlewares
        if parent_link.pipelines is not None and child_link.pipelines is None:
            child_link.pipelines = parent_link.pipelines
```

</CodeGroup>

## 请求与响应

- `crawler/request.py` 的 `Request` 继承 `model.link.Link`，统一承载下载器、代理、重试、管道/中间件、meta 等上下文
- `crawler/response.py` 的 `Response` 提供 `text`/`json`/`xpath`/`css` 等便捷 API，并透传 `meta`

## 中间件与管道

- 中间件：实现 `process_link`、`process_response`、`on_response_header`（可选）
- 管道：实现 `process_item`，在回调产出 Item 后处理（入库、二次处理等）

示例：

```python
class ExampleMiddleware(BaseMiddleware):
    name = "example"
    async def process_link(self, link: Link):
        # 前置加工：如 headers/代理/限流 等
        return link
    async def process_response(self, response: Response, link: Link):
        # 后置加工：如重试/降级/打点 等
        return response

class ExamplePipeline:
    async def process_item(self, item, link: Link):
        # 入库或二次处理，返回 truthy 表示计数
        return True
```

## 链接继承

通过 `_inherit_link_attributes` 将任务级上下文（`demand_id`/`task_id`/`sub_dir`/`proxy_agent`/`middlewares`/`pipelines` 等）在子请求之间安全继承，保持调用链一致性。

## 探索链接（Discovery）

- 回调可直接产出 `DiscoveryLink` 或字符串 URL
- 引擎批量去重、分类、回注任务表（Kafka URL 分类通道）

```python
async def _batch_process_discoveries(self, discovery_queue, link, response):
    async for discoveries in self._batch_get_obj(discovery_queue, self.handling_batch_size):
        # 去重、分发到 URL 分类通道
        ...
```

## 可观测与可靠性

- 请求耗时、大小、状态码、错误类型、详情页命中率
- 错误回调：允许在失败场景下继续派生请求或落盘部分结果
- 去重、重试与代理错误分类记录（Abuyun 限流等）

## 存储抽象（StorageManager）

- 基于 `s3+{cloud}://bucket/...` 统一路径规范（多云：阿里云/火山云/金山云）
- 标准目录：`resources/batch_x/`、`delivery/`、`delivery/mapping`
- `get_resources_child_dir` 自动分桶，避免单目录文件过多
- `open/exists/size/remove/listdir/makedirs/copy/move/glob` 一致化 API
- 提供 `get_mapping_filepath`、`get_meta_file` 便捷方法

```python
sm = StorageManager.from_link(link)
img_dir = sm.get_resources_child_dir(resource_type="images", max_file_count=10000, prefix="data")
img_path = f"{img_dir}/{image_id}.jpg"
with sm.open(img_path, "wb") as f:
    f.write(content)
meta_path = sm.get_meta_file(img_path, meta_filetype="json")
```

<Note>
所有资源文件写入必须使用 `StorageManager`，禁止直接操作底层存储 SDK。
</Note>
