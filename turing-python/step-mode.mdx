---
title: '可服务化开发（Step 模式）'
description: '以任务参数驱动的数据采集与标准化交付实践'
icon: 'workflow'
---

## 核心概念

- **BaseStepSpider**：继承自 `Spider`，通过 `make_requests(**kwargs)` 接收任务参数
- **StepDataItem**：原始数据记录（唯一标识 + 原始数据 + 资源路径 + 扩展信息）
- **StepDataItemMappingItem**：数据映射记录（便于聚合/查找/统计）
- **StorageManager**：标准化资源路径与文件操作，按批次与子目录组织

## 目录结构

- 爬虫：`crawler/step_spiders/...`
- 导出器：`step_export/exporters/...`

## 典型流程

1. 任务中心下发任务（包含 `task_type`/`demand_id`/`task_id`/自定义参数）
2. Step 爬虫 `make_requests` 读取参数并发起请求
3. 回调中解析并产出 `StepDataItem` 和 `StepDataItemMappingItem`
4. 使用 `StorageManager` 落盘资源文件与映射文件
5. 导出器根据任务类型聚合导出

```mermaid
flowchart TD
    A[任务下发\n(task_type, params)] --> B[StepSpider.make_requests]
    B --> C[Engine 下载 + 中间件]
    C --> D[回调解析]
    D --> E[StepDataItem]
    D --> F[StepDataItemMappingItem]
    E --> G[Pipeline 处理/入库]
    F --> G
    G --> H[Exporter 导出]
```

## 代码要点

```python
from crawler.step_spiders.base_step_spider import BaseStepSpider
from crawler import Request, Response
from crawler.items.step_data_item import StepDataItem, StepDataItemMappingItem
from common.storage_manager import StorageManager
import hashlib, time

class XiguaVideoDownloader(BaseStepSpider):
    name = "other.xigua_video_download"
    def make_requests(self, **kwargs):
        keyword = kwargs["keyword"]
        yield Request(url=f"https://www.ixigua.com/search/{keyword}", callback=self.parse_list, meta={"keyword": keyword})
    def parse_list(self, response: Response):
        video_id = "..."
        unique_id = hashlib.sha1(f"{video_id}".encode()).hexdigest()
        yield StepDataItem(
            unique_id=unique_id,
            raw_data={"video_id": video_id, "crawled_at": int(time.time())},
            resource_path={"video": f"videos/{video_id}.mp4"},
        )
        yield StepDataItemMappingItem(
            unique={"source": "xigua", "keyword": response.meta["keyword"], "url": response.url},
            batch_info={"video_id": video_id, "crawled_at": int(time.time())},
        )
```

## 存储规范

使用 `StorageManager.from_link(response.link)` 获取实例：

```python
sm = StorageManager.from_link(response.link)
video_dir = sm.get_resources_child_dir(resource_type="video", max_file_count=10000)
video_path = f"{video_dir}/{video_id}.mp4"
with sm.open(video_path, "wb") as f:
    f.write(binary)
```

## 导出器

导出器需继承 `step_export/exporters/base.py` 的基类，根据任务类型输出统计与映射：

```python
from step_export.exporters.base import BaseExporter

class XiguaVideoExporter(BaseExporter):
    def export(self):
        # 汇总统计 & README 生成
        ...
    def export_mapping_data(self) -> str:
        # 生成 CSV/JSON 等映射文件
        ...
```

<Note>
- 所有文件写入必须通过 `StorageManager`；
- 产出的 `StepDataItem` 与映射记录应保持字段稳定，便于导出器聚合；
- 目录需控制单目录文件数（`get_resources_child_dir`）。
</Note>
